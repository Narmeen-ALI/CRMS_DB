<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRMS | Tactical Map</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <a href="home.html" class="btn">Back to Dashboard</a>
  <nav style="background: #1a1a2e; padding: 15px; display: flex; gap: 20px;">
    <a href="home.html" style="color: white; text-decoration: none;">üè† Home</a>
    <a href="map.html" style="color: white; text-decoration: none;">üìç Tactical Map</a>
    <a href="report.html" style="color: white; text-decoration: none;">üìù File Report</a>
    <a href="#" id="logoutBtn" style="color: #ff4444; text-decoration: none; margin-left: auto;">üö™ Logout</a>
</nav>
  <style>
    body { margin: 0; background: #050510; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
    
    .map-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at center, #1a1a3a 0%, #050510 100%);
    }

    /* --- DESKTOP CONTROLS --- */
    .map-controls {
      position: absolute;
      top: 100px;
      left: 30px;
      z-index: 100;
      background: rgba(10, 10, 30, 0.85);
      padding: 25px;
      border-radius: 4px;
      border: 1px solid rgba(220, 20, 60, 0.5);
      box-shadow: 0 0 30px rgba(220, 20, 60, 0.2);
      width: 300px;
      clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
      transition: all 0.4s ease;
    }

    /* Back Button Style */
    #backBtn {
      position: absolute;
      top: 30px;
      right: 30px;
      z-index: 101;
      background: rgba(220, 20, 60, 0.2);
      color: #fff;
      border: 1px solid #dc143c;
      padding: 10px 20px;
      cursor: pointer;
      display: none; /* Initially Hidden */
      font-weight: bold;
      letter-spacing: 1px;
    }

    /* ==========================================
       MEDIA QUERIES (Mobile & Tablet Logic)
       ========================================== */
    
    /* For Tablets and Mobile */
    @media (max-width: 768px) {
      .map-controls {
        top: auto;
        bottom: 0; /* Sticky to bottom on mobile */
        left: 0;
        width: 100%;
        box-sizing: border-box;
        padding: 20px;
        clip-path: none; /* Mobile par simple rectangle acha lagta hai */
        border-radius: 20px 20px 0 0;
        border-bottom: none;
      }

      h3 { font-size: 1.1rem; margin-bottom: 10px; }

      .control-group label { font-size: 12px; }

      #backBtn {
        top: 20px;
        right: 20px;
        padding: 8px 15px;
        font-size: 12px;
      }
    }

    /* For Small Screens (Landscape or small phones) */
    @media (max-height: 500px) {
      .map-controls {
        width: 200px;
        top: 20px;
        bottom: auto;
        padding: 10px;
      }
      .stats-display { display: none; } /* Choti height par stats hide krdo */
    }

    .control-group select {
      background: #000;
      color: #ff6b6b;
      border: 1px solid #dc143c;
      padding: 10px;
      width: 100%;
      text-transform: uppercase;
      margin-top: 5px;
    }

    .scanner-line {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 2px;
      background: rgba(220, 20, 60, 0.3);
      box-shadow: 0 0 15px #dc143c;
      animation: scan 4s linear infinite;
    }

    @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    .stats-display { border-top: 1px solid #dc143c; margin-top: 15px; padding-top: 10px; }
    .stat-value { color: #00f2ff; float: right; }
  </style>
</head>
<body>

<div class="map-container">
    <div class="scanner-line"></div>
    <button id="backBtn" onclick="goBack()">‚óÄ EXIT</button>

    <div class="map-controls">
      <h3><span style="color:#dc143c">‚ö°</span> TACTICAL OVERLAY</h3>
      <div class="control-group">
        <label>Sector Deployment</label>
        <select id="citySelect">
          <option value="">SCANNING REGIONS...</option>
          <option value="karachi">KARACHI SECTOR</option>
          <option value="lahore">LAHORE SECTOR</option>
          <option value="islamabad">ISLAMABAD SECTOR</option>
        </select>
      </div>

      <div class="stats-display">
        <div class="stat-item">
          Active Precincts: <span class="stat-value" id="totalStations">0</span>
        </div>
        <div class="stat-item" style="margin-top:5px">
          Threat Level: <span class="stat-value" id="threatLevel">STABLE</span>
        </div>
      </div>
    </div>

    <canvas id="mapCanvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let scene, camera, renderer, globe, particles;
    const markers = [];
    const canvas = document.getElementById('mapCanvas');
    const backBtn = document.getElementById('backBtn');
    const citySelect = document.getElementById('citySelect');

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // Grid
        const grid = new THREE.GridHelper(100, 50, 0xdc143c, 0x111122);
        grid.position.y = -10;
        scene.add(grid);

        // Atmosphere
        const pGeometry = new THREE.BufferGeometry();
        const coords = [];
        for(let i=0; i<2000; i++) coords.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
        pGeometry.setAttribute('position', new THREE.Float32BufferAttribute(coords, 3));
        particles = new THREE.Points(pGeometry, new THREE.PointsMaterial({ color: 0xdc143c, size: 0.1 }));
        scene.add(particles);

        globe = new THREE.Mesh(new THREE.IcosahedronGeometry(5, 1), new THREE.MeshBasicMaterial({ color: 0xdc143c, wireframe: true, transparent: true, opacity: 0.2 }));
        scene.add(globe);

        animate();
    }

    citySelect.addEventListener('change', (e) => {
        const city = e.target.value;
        if(!city) return;
        
        backBtn.style.display = "block"; // Show exit button
        markers.forEach(m => scene.remove(m));
        markers.length = 0;

        document.getElementById('threatLevel').textContent = city === 'karachi' ? 'HIGH' : 'ELEVATED';
        document.getElementById('totalStations').textContent = "6 UNITS";

        for(let i=0; i<6; i++) {
            const group = new THREE.Group();
            const mesh = new THREE.Mesh(new THREE.OctahedronGeometry(0.8), new THREE.MeshPhongMaterial({ color: 0x00f2ff, emissive: 0x00f2ff }));
            const ring = new THREE.Mesh(new THREE.RingGeometry(1.2, 1.4, 32), new THREE.MeshBasicMaterial({ color: 0xdc143c, side: THREE.DoubleSide }));
            ring.rotation.x = Math.PI/2;
            group.add(mesh, ring);
            const angle = (i / 6) * Math.PI * 2;
            group.position.set(Math.cos(angle)*15, -9, Math.sin(angle)*15);
            scene.add(group);
            markers.push(group);
        }
        gsap.to(camera.position, { z: 45, y: 20, duration: 1.5 });
    });

    // BACK FUNCTION
    window.goBack = () => {
        citySelect.value = "";
        backBtn.style.display = "none";
        markers.forEach(m => scene.remove(m));
        document.getElementById('threatLevel').textContent = "STABLE";
        document.getElementById('totalStations').textContent = "0";
        gsap.to(camera.position, { x: 0, y: 0, z: 30, duration: 1.5 });
    };

    // WINDOW RESIZE (Critical for Mobile)
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        globe.rotation.y += 0.005;
        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.lookAt(0,0,0);
        renderer.render(scene, camera);
    }

    let mouseX = 0;
    window.addEventListener('mousemove', (e) => {
        mouseX = (e.clientX - window.innerWidth / 2) / 100;
    });

    init();
</script>
</body>
</html>